import React, { useState, useEffect } from 'react';
import { Rota, Plano, ResultSummary, DomainConfig, Question } from './types';
import { LandingPage } from './screens/LandingPage';
import { Painel } from './screens/Painel';
import { QuizScreen } from './screens/QuizScreen';
import { ReviewScreen } from './screens/ReviewScreen';
import { ResultScreen } from './screens/ResultScreen';
import { DominiosScreen } from './screens/DominiosScreen';
import { AuthScreen } from './screens/AuthScreen';
import { CertificationSelector } from './screens/CertificationSelector';
import { PaywallModal } from './screens/PaywallModal';
import { LoadingOverlay } from './components/ui/LoadingOverlay';
import { Modal } from './components/ui/Modal';
import { Button } from './components/ui/Button';
import { ScreenTransition, QuizTransition, ResultTransition, PanelTransition } from './components/common/PageTransition';
import { useAuthStore } from './store/authStore';
import { useQuestions } from './hooks/useQuestions';
import { getWeeklySeed } from './utils';

const Changelog: React.FC<{open: boolean, onClose: () => void, onAck: () => void}> = ({ open, onClose, onAck }) => (
    <Modal open={open} onClose={onClose} title="Atualização — Out/25">
        <ul className="list-disc pl-5 space-y-2 text-sm">
            <li>SSO com Google para histórico e sincronização.</li>
            <li>Modo Revisão (PRO): grid de revisão, voltar, filtros, favoritos e explicações completas.</li>
            <li>Prática por domínios: Arquitetura segura · resiliente · alto desempenho · custo otimizado.</li>
            <li>Banco expandido para 650 questões; complementação on‑the‑fly via LLM.</li>
            <li>Quiz Rápido (GRATUITO): forward‑only; pool de 100 (rotaciona a cada 2 dias).</li>
        </ul>
        <div className="mt-6 flex justify-end gap-2">
            <Button onClick={() => { if (onAck) onAck(); onClose(); }}>Ok, entendi</Button>
        </div>
    </Modal>
);

const ModalQuizRapido: React.FC<{open: boolean, onClose: () => void, onStart: () => void, plano: Plano}> = ({ open, onClose, onStart, plano }) => (
    <Modal open={open} onClose={onClose} title="Quiz Rápido — Formato">
        <ul className="list-disc pl-5 space-y-2 text-sm">
            <li><b>35 questões</b> por tentativa, {plano === 'PRO' ? 'selecionadas aleatoriamente do banco de questões completo.' : 'selecionadas aleatoriamente de um pool de 100 questões (renova a cada 24 horas).'}</li>
            <li>Até <b>40 minutos</b> de duração.</li>
            {plano === 'PRO' ? (
                <>
                    <li><b>Recursos PRO ativados:</b> Explicações detalhadas, aprendizado com IA e navegação completa.</li>
                </>
            ) : (
                <>
                    <li>Explicações <b>resumidas</b>.</li>
                    <li>Funcionalidades de revisão e navegação <b>desabilitadas</b>.</li>
                </>
            )}
        </ul>
        <div className="mt-6 flex justify-end gap-2">
            <Button onClick={onStart}>Iniciar</Button>
        </div>
    </Modal>
);

const ModalQuizCompleto: React.FC<{open: boolean, onClose: () => void, onStart: () => void}> = ({ open, onClose, onStart }) => (
    <Modal open={open} onClose={onClose} title="Quiz Completo — Formato Simulado">
        <ul className="list-disc pl-5 space-y-2 text-sm">
            <li><b>Formato Oficial:</b> 65 questões com proporções de domínios baseadas no exame SAA-C03.</li>
            <li><b>Tempo Real:</b> Simulação com 130 minutos, igual à prova.</li>
            <li><b>Navegação Completa:</b> Você pode voltar para revisar e alterar suas respostas.</li>
            <li><b>Explicações Detalhadas:</b> Todas as questões incluem explicações completas (recurso PRO).</li>
            <li><b>Aprendizado profundo:</b> Aprofunde seu conhecimento com explicações alternativas e analogias geradas por IA.</li>
            <li><b>Nota Final:</b> Ao final, você receberá uma pontuação simulada no padrão AWS (100-1000).</li>
        </ul>
        <div className="mt-6 flex justify-end gap-2">
            <Button onClick={onStart}>Iniciar Simulado</Button>
        </div>
    </Modal>
);

export default function App() {
    // Auth state
    const { user, profile, isLoading: authLoading, isInitialized, initialize, isPro } = useAuthStore();

    const certificationId = 'SAA-C03';

    const [rota, setRota] = useState<Rota>("landing");
    const [plano, setPlano] = useState<Plano>("FREE");
    const [showChangelog, setShowChangelog] = useState(false);
    const [loading, setLoading] = useState(false);
    const [showQuick, setShowQuick] = useState(false);
    const [showCompleto, setShowCompleto] = useState(false);
    const [showPaywall, setShowPaywall] = useState(false);
    const [resultSummary, setResultSummary] = useState<ResultSummary | null>(null);
    const [domCfg, setDomCfg] = useState<DomainConfig | null>(null);

    const weeklySeed = getWeeklySeed({ userId: user?.id, certificationId });

    // Buscar questões do Supabase
    const { questions: questionsQuickFree, loading: loadingQuickFree } = useQuestions({
        certificationId,
        tier: 'FREE',
        limit: 100,
        take: 10,
        seed: weeklySeed,
        enabled: rota === 'quiz-rapido' && plano === 'FREE'
    });

    const { questions: questionsQuickPro, loading: loadingQuickPro } = useQuestions({
        certificationId,
        tier: 'ALL',
        limit: 100,
        enabled: rota === 'quiz-rapido' && plano === 'PRO'
    });

    const { questions: questionsCompleto, loading: loadingCompleto } = useQuestions({
        certificationId,
        tier: 'ALL',
        limit: 65,
        enabled: rota === 'quiz-completo'
    });

    const { questions: questionsDominios, loading: loadingDominios } = useQuestions({
        certificationId,
        domains: domCfg ? Object.keys(domCfg.dom).filter(d => domCfg.dom[d as keyof typeof domCfg.dom]) : undefined,
        tier: 'ALL',
        limit: domCfg?.qtd,
        enabled: rota === 'quiz-dominios' && !!domCfg
    });

    const total = 650;

    const [theme, setTheme] = useState(() => {
        if (typeof window !== 'undefined') {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) return savedTheme;
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        return 'light';
    });

    // Inicializar autenticação
    useEffect(() => {
        if (!isInitialized) {
            initialize();
        }
    }, [isInitialized, initialize]);

    // Sincronizar plano com profile
    useEffect(() => {
        if (profile) {
            setPlano(isPro() ? 'PRO' : 'FREE');
        }
    }, [profile, isPro]);

    useEffect(() => {
        if (theme === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        localStorage.setItem('theme', theme);
    }, [theme]);

    const toggleTheme = () => {
        setTheme(prevTheme => (prevTheme === 'light' ? 'dark' : 'light'));
    };

    useEffect(() => {
        if (rota === 'painel') setShowChangelog(true);
    }, [rota]);

    const start = (fn: () => void) => {
        setLoading(true);
        setTimeout(() => { setLoading(false); fn(); }, 900);
    };

    const handleQuizExit = (summary: ResultSummary) => {
        setResultSummary(summary);
        setRota('resultado');
    }

    const renderContent = () => {
        // Mostrar loading enquanto inicializa auth
        if (authLoading || !isInitialized) {
            return <LoadingOverlay open={true} message="Carregando..." />;
        }

        switch (rota) {
            case 'landing': return (
                <ScreenTransition key="landing">
                    <LandingPage
                        onLoginSuccess={() => setRota('painel')}
                        onShowAuth={() => setRota('auth')}
                    />
                </ScreenTransition>
            );
            case 'auth': return (
                <ScreenTransition key="auth">
                    <AuthScreen
                        onSuccess={() => setRota('painel')}
                        onCancel={() => setRota('landing')}
                    />
                </ScreenTransition>
            );
            case 'painel': return (
                <PanelTransition key="painel">
                    <>
                        <Painel
                            plano={plano}
                            totalQuestoes={total}
                            onQuizRapido={() => setShowQuick(true)}
                            onQuizCompleto={() => plano === 'PRO' ? setShowCompleto(true) : setShowPaywall(true)}
                            onDominios={() => plano === 'PRO' ? setRota('dominios') : setShowPaywall(true)}
                            onRevisao={() => plano === 'PRO' ? setRota('revisao') : setShowPaywall(true)}
                            theme={theme}
                            toggleTheme={toggleTheme}
                        />
                        <div className="fixed bottom-4 right-4 flex items-center gap-2 bg-white dark:bg-gray-800 border dark:border-gray-700 shadow px-3 py-2" style={{ borderRadius: 12 }}>
                            <span className="text-sm text-gray-700 dark:text-gray-300">Simular plano:</span>
                            <Button className="px-3 py-1" onClick={() => setPlano(p => p === 'FREE' ? 'PRO' : 'FREE')}>{plano === 'FREE' ? 'Gratuito' : 'PRO'}</Button>
                        </div>
                    </>
                </PanelTransition>
            );
            case 'quiz-rapido': return (
                <QuizTransition key="quiz-rapido">
                    {(loadingQuickFree || loadingQuickPro) ? (
                        <LoadingOverlay open={true} message="Carregando questões..." />
                    ) : (
                        <QuizScreen
                            plano={plano}
                            tamanho={35}
                            level={plano === 'PRO' ? 'detailed' : 'basic'}
                            onSair={handleQuizExit}
                            onExit={() => setRota('painel')}
                            timed
                            durationSec={40 * 60}
                            navAfterBack={plano === 'PRO'}
                            theme={theme}
                            toggleTheme={toggleTheme}
                            questions={plano === 'FREE' ? questionsQuickFree : questionsQuickPro}
                            quizType="daily"
                        />
                    )}
                </QuizTransition>
            );
            case 'quiz-completo': return (
                <QuizTransition key="quiz-completo">
                    {loadingCompleto ? (
                        <LoadingOverlay open={true} message="Carregando questões..." />
                    ) : (
                        <QuizScreen
                            plano={plano}
                            tamanho={65}
                            level={'detailed'}
                            timed
                            durationSec={130 * 60}
                            navAfterBack
                            onSair={handleQuizExit}
                            onExit={() => setRota('painel')}
                            theme={theme}
                            toggleTheme={toggleTheme}
                            questions={questionsCompleto}
                            quizType="full"
                        />
                    )}
                </QuizTransition>
            );
            case 'quiz-dominios': return (
                <QuizTransition key="quiz-dominios">
                    {loadingDominios ? (
                        <LoadingOverlay open={true} message="Carregando questões..." />
                    ) : (
                        <QuizScreen
                            plano={plano}
                            tamanho={(domCfg && domCfg.qtd) || 20}
                            level={'detailed'}
                            navAfterBack
                            onSair={handleQuizExit}
                            onExit={() => setRota('painel')}
                            theme={theme}
                            toggleTheme={toggleTheme}
                            questions={questionsDominios}
                            quizType="domains"
                        />
                    )}
                </QuizTransition>
            );
            case 'revisao': return (
                <ScreenTransition key="revisao">
                    <ReviewScreen onBack={() => setRota('painel')} plano={plano} theme={theme} toggleTheme={toggleTheme} />
                </ScreenTransition>
            );
            case 'resultado': return (
                <ResultTransition key="resultado">
                    <ResultScreen summary={resultSummary} onBack={() => setRota('painel')} theme={theme} toggleTheme={toggleTheme} />
                </ResultTransition>
            );
            case 'dominios': return (
                <ScreenTransition key="dominios">
                    <DominiosScreen onVoltar={() => setRota('painel')} onIniciar={(cfg) => { setDomCfg(cfg); start(() => setRota('quiz-dominios')); }} theme={theme} toggleTheme={toggleTheme} />
                </ScreenTransition>
            );
            default: return (
                <ScreenTransition key="default">
                    <LandingPage onLoginSuccess={() => setRota('painel')} />
                </ScreenTransition>
            );
        }
    }
    
    return (
        <div className="min-h-screen cloudy-bg">
            <style>{`
                .cloudy-bg { background-color: #f0f4f8; background-image: radial-gradient(circle at 10% 20%, hsla(0,0%,100%,.3) 0%, transparent 40%), radial-gradient(circle at 80% 50%, hsla(0,0%,100%,.2) 0%, transparent 50%), radial-gradient(circle at 50% 90%, hsla(0,0%,100%,.1) 0%, transparent 40%); transition: background-color 0.5s; }
                .dark .cloudy-bg { background-color: #0b1120; background-image: radial-gradient(circle at 25% 30%, rgba(30, 58, 138, 0.35) 0%, #0b1120 35%), radial-gradient(circle at 80% 60%, rgba(30, 64, 175, 0.25) 0%, #0b1120 40%); }
                .dashboard-bg { background-color: #020617; background-image: radial-gradient(circle at 1% 1%, #1e293b 0%, #020617 25%), radial-gradient(circle at 99% 99%, #334155 0%, #020617 25%); transition: background-color 0.5s; }
                .card-spotlight::before { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(300px circle at var(--mouse-x) var(--mouse-y), rgba(37, 99, 235, 0.15), transparent 80%); border-radius: inherit; opacity: 0; transition: opacity 0.2s; }
                .card-spotlight:hover::before { opacity: 1; }
                .dark .card-spotlight::before { background: radial-gradient(300px circle at var(--mouse-x) var(--mouse-y), rgba(59, 130, 246, 0.15), transparent 80%); }
                .recharts-cartesian-axis-tick-value { font-size: 0.75rem; fill: #94a3b8; }
                .recharts-tooltip-cursor { stroke: rgba(148, 163, 184, 0.3); stroke-width: 1; stroke-dasharray: 5 5; }
            `}</style>
            
            {renderContent()}

            <Changelog open={showChangelog} onClose={() => setShowChangelog(false)} onAck={() => { }} />
            <ModalQuizRapido open={showQuick} onClose={() => setShowQuick(false)} onStart={() => { setShowQuick(false); start(() => setRota('quiz-rapido')); }} plano={plano} />
            <ModalQuizCompleto open={showCompleto} onClose={() => setShowCompleto(false)} onStart={() => { setShowCompleto(false); start(() => setRota('quiz-completo')); }} />
            <PaywallModal open={showPaywall} onClose={() => setShowPaywall(false)} />
            <LoadingOverlay open={loading} message="Preparando questões…" />
        </div>
    );
}

